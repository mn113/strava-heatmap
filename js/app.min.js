/*global heatmap, renderer, ui, Zepto, $, L, rides, ajax */
var ajax={};ajax.getClubRides=function(e){console.log("ajax.getClubRides("+e+")"),$(".reload").hide().off("click"),$.ajax({url:"apirequests.php",data:{resource:"club_activities",id:e},dataType:"json",timeout:3e3,success:function(t){t.forEach(function(e){rides.all.push(e)}),$(".club-rides").removeClass("active");var a=$("<ul></ul>");a.addClass("club-rides active"),a.data("clubid",e),a.html(renderer.printListItems(t)),$("#rides").append(a),ui.colourTitles(),ui.attachLiClickListeners(),heatmap.populateClubLayer(e),heatmap.filterPaths(rides.applyFilter()),ui.filterHTML(rides.applyFilter())},error:function(){console.log("Failed to load club rides for",e),$(".reload").on("click",function(){ajax.getClubRides(e)}).show()}})},ajax.getFriendsRides=function(){console.log("ajax.getFriendsRides()"),$(".reload").hide().off("click"),$.ajax({url:"apirequests.php",data:{resource:"friend_activities"},dataType:"json",timeout:3e3,success:function(e){e.forEach(function(e){rides.all.push(e)}),$(".friends-rides").html(renderer.printListItems(e)),ui.colourTitles(),ui.attachLiClickListeners(),heatmap.populateFriendsLayer(),heatmap.filterPaths(rides.applyFilter()),ui.filterHTML(rides.applyFilter())},error:function(){console.log("Failed to load friend rides"),$(".reload").on("click",function(){ajax.getFriendsRides()}).show()}})},ajax.getClubs=function(){console.log("ajax.getClubs()"),$.ajax({url:"apirequests.php",data:{resource:"clubs"},dataType:"json",timeout:3e3,success:function(e){ui.clubs=e,$('select[name="clubs"]').html(renderer.printClubs(e));var t=$("select[name=clubs] option:first-child").data("cid");ajax.getClubRides(t),ui.setClub(t)}})},ajax.geoLookup=function(e,t){var a="https://maps.googleapis.com/maps/api/geocode/json?address="+e+","+t;$.getJSON(a,function(e){"OK"===e.status&&heatmap.zoomMap(e.results[0].geometry.location,9)})};var renderer={};renderer.formatDate=function(e){var t=new Date(e),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return t.getDate()+" "+a[t.getMonth()]},renderer.formatTime=function(e){var t=new Date(e),a=t.getHours(),r=t.getMinutes();return a<10&&(a="0"+a),r<10&&(r="0"+r),a+":"+r},renderer.formatKm=function(e){return(e/1e3).toFixed(1)+"km"},renderer.formatElev=function(e){return e.toFixed(0)+"m"},renderer.formatSpeed=function(e){return(3.6*e).toFixed(1)+"km/h"},renderer.printListItems=function(e){for(var t="",a=0;a<e.length;a++){var r=e[a];r.map.summary_polyline&&(t+=`<li ${renderer.printRideDataAttributes(r,r.athlete)}>
\t\t\t         ${renderer.printRideDetails(r,r.athlete)}
\t\t\t         </li>`)}return t},renderer.printRideDataAttributes=function(e,t){var a=`data-rideid="${e.id}"
            \tdata-date="${renderer.formatDate(e.start_date_local)}"
            \tdata-time="${renderer.formatTime(e.start_date_local)}"
            \tdata-title="${e.name}"
            \tdata-type="${e.type}"
            \tdata-dist="${renderer.formatKm(e.distance)}"
            \tdata-elev="${renderer.formatElev(e.total_elevation_gain)}"
\t\t\t\tdata-speed="${renderer.formatSpeed(e.average_speed)}"
            \tdata-athlete="${t.firstname} ${t.lastname}"
\t\t\t\tdata-athleteid="${t.id}"
            \tdata-avatar="${t.profile}"
            \tdata-summary="${e.map.summary_polyline}"`;return a},renderer.printRideDetails=function(e,t){var a=`<h6>
\t\t\t\t\t<span class="icon ${e.type.toLowerCase()}"></span>
\t\t\t\t\t${e.name}
\t\t\t\t\t${renderer.makeRideLink(e.id)}
\t\t\t\t</h6>
            \t<span>${renderer.formatDate(e.start_date_local)} ${renderer.formatTime(e.start_date_local)}</span>
            \t<div>
\t\t\t\t\t${renderer.printAthlete(t)}
\t\t\t\t</div>
            \t<span>&roarr;&nbsp;${renderer.formatKm(e.distance)}</span>
            \t<span>&lrtri;&nbsp;${renderer.formatElev(e.total_elevation_gain)}</span>
\t\t\t\t<span>&raquo;&nbsp;${renderer.formatSpeed(e.average_speed)}</span>
\t\t\t\t`;return a},renderer.printAthlete=function(e){var t=`<img class="avatar" src="${e.profile}">
            \t<span class="athlete">${renderer.makeAthleteLink(e.id,e.firstname+" "+e.lastname)}</span>
            \t<span class="city">(${e.city})</span>`;return t},renderer.printClubs=function(e){for(var t="",a=0;a<e.length;a++){var r=e[a];t+=`<option data-cid="${r.id}">${r.name}</option>`}return t},renderer.makeAthleteLink=function(e,t){return`<a target="_blank" href="http://www.strava.com/athletes/${e}">${t}</a>`},renderer.makeRideLink=function(e){return`<a target="_blank" class="stravalink" href="http://www.strava.com/activities/${e}"></a>`};var heatmap={map:null,layerGroups:null,layerControl:null,paths:{},topLayerIndex:1e3,init:function(){var e=`&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> + <a href="http://mapbox.com">Mapbox</a>`,t="https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=",a="pk.eyJ1IjoibWVlcmthdG9yIiwiYSI6ImNpdXF4Mm91azAwMGEyb21pcDFmN3J5NXcifQ.pW6SQDz9wpFr619vzHtcAA",r=L.tileLayer(t+a,{attribution:e,maxZoom:20,id:"lightBase"}),i=[35,0];this.map=L.map("map",{center:i,zoom:1,layers:[r]}),this.locateUser(),this.initLayers()},initLayers:function(){this.layerGroups={Friends:new L.LayerGroup},this.layerControl=new L.Control.Layers(null,this.layerGroups,{hideSingleBase:!0}),this.layerControl.addTo(this.map)},locateUser:function(){mode&&"logged"===mode&&user.city&&ajax.geoLookup(user.city,user.country)},zoomMap(e,t){heatmap.map.setView(e,t)},makeLayerGroup:function(e){var t=new L.LayerGroup;return t.addTo(this.map),this.layerControl.addOverlay(t,e),this.layerGroups[e]=t,t},createPath:function(e){var t=window.polyline.decode(e.path),a=L.polyline(t,{color:ui.selectColour(e.rideId)||"red",opacity:"0.8",weight:3,className:"rid"+e.rideId});return e.color=ui.selectColour(e.rideId),a.data=e,a.tooltipContent=this.preparePathTooltip(e),a.on("click",function(e){var t=L.latLng(e.latlng);heatmap.map.openPopup(this.tooltipContent,t)}),heatmap.paths[e.rideId]=a,a},preparePathTooltip(e){},addPathToLayerGroup:function(e,t){this.layerGroups[t].addLayer(e)},getLayerGroupByName:function(e){for(var t=0;t<this.layerGroups.length;t++){var a=this.layerGroups[t];if(a.name===e)return a.layer}return!1},highlightPath:function(e){var t=heatmap.paths[e].getBounds();heatmap.map.fitBounds(t,{padding:[20,20]}),$.each(heatmap.paths,function(e,t){t.setStyle({opacity:.6,weight:3})}),heatmap.paths[e].setStyle({opacity:1,weight:4}),heatmap.paths[e].bringToFront(),heatmap.paths[e].openPopup()},getClubNameById:function(e){if(ui.clubs.length>0)for(var t=0;t<ui.clubs.length;t++){var a=ui.clubs[t];if(a.id===e)return a.name}return!1},populateFriendsLayer:function(){$(".friends-rides li").each(function(e,t){var a=$(t);heatmap.populateLayer(a,"Friends")})},populateClubLayer:function(e){var t=this.getClubNameById(e);heatmap.makeLayerGroup(t),console.log("Made map layerGroup:",t),$(".club-rides[data-clubid='"+e+"'] li").each(function(e,a){var r=$(a);heatmap.populateLayer(r,t)})},populateLayer:function(e,t){var a={rideId:e.data("rideid"),title:e.data("title"),date:e.data("date"),time:e.data("time"),type:e.data("type"),dist:e.data("dist"),elev:e.data("elev"),speed:e.data("speed"),athlete:e.data("athlete"),athleteId:e.data("athleteid"),avatar:e.data("avatar"),path:e.data("summary")};if(a.path){var r=heatmap.createPath(a);heatmap.addPathToLayerGroup(r,t),heatmap.map.addLayer(r)}},filterPaths:function(e){console.log("Filtering to",e.length,"paths"),$("path.leaflet-interactive").hide(),e.forEach(function(e){$(".rid"+e.id).show()})},countVisiblePaths:function(){var e=$("path").filter(function(){return $(this).is(":visible")});return e.length+" paths shown"}},ui={clubs:[],activeClub:null,getClubs:function(){ajax.getClubs()},setClub:function(e){this.activeClub=e},selectColour:function(e){var t=["#c543a9","#ff99ff","#e62e00","#e6726f","#ffa124","#ffca99","#ffe600","#cccc00","#bae221","#91e8af","#00c17a","#7ddfff","#5395e0","#0054b6","#cc99ff","#5500cc"];return t[e%16]},colourTitles:function(){$("li > h6").each(function(e,t){var a=$(t).parent().data("rideid");$(t).css("color",ui.selectColour(a))})},filterHTML:function(e){$("li").hide(),e.forEach(function(e){$('li[data-rideid="'+e.id+'"]').show()})},setActiveTab(e){"friends"===e?($("#sidebar").removeClass("clubs").addClass("friends"),$("#clubs-btn").removeClass("button-primary"),$("#friends-btn").addClass("button-primary")):"clubs"===e&&($("#sidebar").removeClass("friends").addClass("clubs"),$("#friends-btn").removeClass("button-primary"),$("#clubs-btn").addClass("button-primary"))},attachLiClickListeners(){$("#rides ul").on("click","li",function(e){var t=$(this).attr("data-rideid");heatmap.highlightPath(t),$(".selected").removeClass("selected"),$(this).addClass("selected")})}};Zepto(function(e){heatmap.init(),heatmap.map&&("logged"===mode&&ajax.getFriendsRides(),ajax.getClubs()),"demo"===mode&&ui.setActiveTab("clubs"),e(".autohide").each(function(){var t=e(this);setTimeout(function(){e(t).animate({left:"-100%"},1500)},2e3)}),e("#friends-btn").click(function(){ui.setActiveTab("friends")}),e("#clubs-btn").click(function(){ui.setActiveTab("clubs")}),e('select[name="clubs"]').on("change",function(){var t=e(this).find("option:selected").data("cid"),a=e('.club-rides[data-clubid="'+t+'"]');0===a.length?(console.log("AJAX-fetching activites from club",t),ajax.getClubRides(t)):(e(".club-rides").removeClass("active"),e(a).addClass("active"))}),e("#options > a").click(function(){var t=e("#map-options");e(t).hasClass("open")?(e(t).removeClass("open"),e(this).children("span").html("&rtrif;")):(e(t).addClass("open"),e(this).children("span").html("&dtrif;"))}),e('#map-options input[type="checkbox"]').on("change",function(){var t=e(this).attr("name"),a=e(this).prop("checked");rides.filter[t]=a,heatmap.filterPaths(rides.applyFilter()),ui.filterHTML(rides.applyFilter())}),e('#map-options input[type="number"]').on("change",function(){var t=e(this).attr("name"),a=e(this).val();this.validity.valid?(rides.filter[t]=a,heatmap.filterPaths(rides.applyFilter()),ui.filterHTML(rides.applyFilter())):console.log(e(this).val(),this.validity)}),e(".modal-dialog a").click(function(){e(".modal-bg").hide()}),e(".cookie-message a").click(function(){e(this).parent().addClass("hidden"),document.cookie="okCookies=true"})});var rides={all:[],filter:{excludeSelf:!1,includeRides:!0,includeRuns:!1,includeOthers:!1,dateRange:7,minDistance:2,maxDistance:200},arrayifyTypes:function(){var e=[];return rides.filter.includeRides&&e.push("rides"),rides.filter.includeRuns&&e.push("runs"),rides.filter.includeOthers&&e.push("others"),e},applyFilter:function(){var e=rides.filterSelf(rides.all),t=rides.filterByType(e),a=rides.filterByDateRange(t),r=rides.filterByDistance(a);return r},filterSelf:function(e){var t=e.filter(function(e){return!rides.filter.excludeSelf||e.athlete.id!==user.id});return t},filterByType:function(e){var t=rides.arrayifyTypes(),a=e.filter(function(e){return"Ride"===e.type&&t.indexOf("rides")!==-1||"Run"===e.type&&t.indexOf("runs")!==-1||"Ride"!==e.type&&"Run"!==e.type&&t.indexOf("others")!==-1});return a},filterByDateRange:function(e){var t=rides.filter.dateRange,a=(new Date).getTime()-24*t*60*60*1e3,r=e.filter(function(e){var t=new Date(e.start_date_local).getTime();return t>a});return r},filterByDistance:function(e){var t=e.filter(function(e){return e.distance/1e3>rides.filter.minDistance&&e.distance/1e3<rides.filter.maxDistance});return t}};